<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o Cl√≠nica Elizabeth [STI]</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .col-oculta { display: none !important; }
        .card-gestao { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .privacidade-toggle { cursor: pointer; color: #4285F4; margin-left: 5px; }
        .btn-filtro.ativo { background: #D4AF37; color: white; }
    </style>
</head>
<body style="background: #f4f7f6; padding: 20px; font-family: 'Segoe UI', sans-serif;">

    <script>
        const senhaDefinida = "1234";
        const entrada = prompt("√Årea Restrita [STI]. Senha:");
        if (entrada !== senhaDefinida) window.location.replace("index.html");
    </script>

    <div style="max-width: 1300px; margin: 0 auto;">
        
        <header class="card-gestao" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h2 style="color: #D4AF37; margin: 0;">Gest√£o Elizabeth Cruz</h2>
                <p style="color: #666; margin: 5px 0 0 0;">Painel Administrativo STI</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="carregarDados()" style="background: #4285F4; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">üîÑ Atualizar</button>
                <button onclick="exportarParaPDF()" style="background: #2E7D32; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">üìÑ PDF Seguro</button>
            </div>
        </header>

        <section class="card-gestao">
            <h3 style="color: #D4AF37;">üë• Gest√£o de Funcion√°rios</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="text" id="func-nome" placeholder="Nome do Funcion√°rio" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; flex: 2;">
                <input type="text" id="func-cargo" placeholder="Cargo/Fun√ß√£o" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; flex: 1;">
                <button onclick="adicionarFuncionario()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">‚ûï Adicionar</button>
            </div>
            <table style="width: 100%; border-collapse: collapse;">
                <thead><tr style="border-bottom: 2px solid #D4AF37; text-align: left;"><th style="padding: 10px;">Nome</th><th style="padding: 10px;">Cargo</th><th style="padding: 10px;">A√ß√µes</th></tr></thead>
                <tbody id="tabela-funcionarios"></tbody>
            </table>
        </section>

        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 25px;">
            <div class="card-gestao"><canvas id="chartStatus"></canvas></div>
            <div class="card-gestao" style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
                <h1 id="totalAgendamentos" style="font-size: 48px; margin: 0;">0</h1>
                <p>Pacientes Cadastrados</p>
            </div>
        </div>

        <div class="card-gestao" style="overflow-x: auto;">
            <table id="tabela-admin" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #D4AF37; color: white;">
                        <th style="padding: 15px; text-align: left;">Data</th>
                        <th style="padding: 15px; text-align: left;">CPF</th>
                        <th style="padding: 15px; text-align: left;">Paciente</th>
                        <th style="padding: 15px; text-align: left;">Respons√°vel</th> 
                        <th style="padding: 15px; text-align: center;">Status</th>
                        <th style="padding: 15px; text-align: center;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="corpo-tabela"></tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:3000' : 'https://clinica-elizabeth19-01-2026.onrender.com';
        let meuGrafico = null;
        let listaFuncionariosGlobal = [];

        async function carregarDados() {
            try {
                // 1. Carregar Funcion√°rios
                const resFunc = await fetch(`${API_BASE_URL}/api/funcionarios`);
                listaFuncionariosGlobal = await resFunc.json();
                renderizarTabelaFuncionarios();

                // 2. Carregar Contatos
                const resCont = await fetch(`${API_BASE_URL}/api/listar-contatos`);
                const agendamentos = await resCont.json();
                
                const corpo = document.getElementById("corpo-tabela");
                corpo.innerHTML = "";
                document.getElementById('totalAgendamentos').innerText = agendamentos.length;
                let statusCount = { 'Pendente': 0, 'Atendido': 0, 'Cancelado': 0 };

                agendamentos.forEach(cli => {
                    const statusAtual = cli.status || 'Pendente';
                    statusCount[statusAtual]++;

                    let selectFunc = `<select onchange="vincularFuncionario(${cli.id}, this.value)" style="padding:5px; border-radius:5px;">
                        <option value="N√£o Atribu√≠do">-- Selecionar --</option>`;
                    listaFuncionariosGlobal.forEach(f => {
                        selectFunc += `<option value="${f.nome}" ${cli.funcionario_resp === f.nome ? 'selected' : ''}>${f.nome}</option>`;
                    });
                    selectFunc += `</select>`;

                    corpo.innerHTML += `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 15px;">${new Date(cli.data_cadastro).toLocaleDateString('pt-BR')}</td>
                            <td style="padding: 15px; font-family: monospace;">***.***.***-**</td>
                            <td style="padding: 15px; font-weight: bold;">${cli.nome_completo}</td>
                            <td style="padding: 15px;">${selectFunc}</td> 
                            <td style="padding: 15px; text-align: center;">
                                <select onchange="atualizarStatus(${cli.id}, this.value)" style="padding:5px; border-radius:5px; background: ${statusAtual === 'Atendido' ? '#d4edda' : '#fff3cd'}">
                                    <option value="Pendente" ${statusAtual === 'Pendente' ? 'selected' : ''}>Pendente</option>
                                    <option value="Atendido" ${statusAtual === 'Atendido' ? 'selected' : ''}>Atendido</option>
                                    <option value="Cancelado" ${statusAtual === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
                                </select>
                            </td>
                            <td style="padding: 15px; text-align: center;">
                                <span onclick="confirmarExclusao(${cli.id})" style="cursor:pointer; color: red;">üóëÔ∏è</span>
                            </td>
                        </tr>`;
                });
                renderizarGrafico(statusCount);
            } catch (err) { console.error("Erro STI:", err); }
        }

        function renderizarTabelaFuncionarios() {
            const corpo = document.getElementById("tabela-funcionarios");
            corpo.innerHTML = "";
            listaFuncionariosGlobal.forEach(f => {
                corpo.innerHTML += `<tr style="border-bottom: 1px solid #eee;"><td style="padding: 10px;">${f.nome}</td><td style="padding: 10px;">${f.cargo}</td><td style="padding: 10px;"><button onclick="excluirFuncionario(${f.id})" style="border:none; background:none; color:red; cursor:pointer;">üóëÔ∏è</button></td></tr>`;
            });
        }

        async function adicionarFuncionario() {
            const nome = document.getElementById("func-nome").value;
            const cargo = document.getElementById("func-cargo").value;
            if(!nome || !cargo) return alert("Preencha tudo!");
            await fetch(`${API_BASE_URL}/api/funcionarios`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ nome, cargo }) });
            document.getElementById("func-nome").value = ""; document.getElementById("func-cargo").value = "";
            carregarDados();
        }

        async function excluirFuncionario(id) {
            if(confirm("Remover funcion√°rio?")) { await fetch(`${API_BASE_URL}/api/funcionarios/${id}`, { method: 'DELETE' }); carregarDados(); }
        }

        async function vincularFuncionario(id, funcionario) {
            await fetch(`${API_BASE_URL}/api/vincular-funcionario/${id}`, { method: 'PATCH', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ funcionario }) });
        }

        async function atualizarStatus(id, status) {
            await fetch(`${API_BASE_URL}/api/atualizar-status/${id}`, { method: 'PATCH', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ status }) });
            carregarDados();
        }

        async function confirmarExclusao(id) {
            if(confirm("Excluir agendamento?")) { await fetch(`${API_BASE_URL}/api/excluir-contato/${id}`, { method: 'DELETE' }); carregarDados(); }
        }

        function renderizarGrafico(counts) {
            const ctx = document.getElementById('chartStatus').getContext('2d');
            if (meuGrafico) meuGrafico.destroy();
            meuGrafico = new Chart(ctx, { type: 'doughnut', data: { labels: ['Pendente', 'Atendido', 'Cancelado'], datasets: [{ data: [counts['Pendente'], counts['Atendido'], counts['Cancelado']], backgroundColor: ['#fff3cd', '#d4edda', '#f8d7da'] }] } });
        }

        window.onload = carregarDados;
    </script>
</body>
</html>