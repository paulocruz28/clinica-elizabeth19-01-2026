<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o Cl√≠nica Elizabeth [STI]</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .col-oculta { display: none !important; }
        .card-gestao { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .privacidade-toggle { cursor: pointer; color: #4285F4; margin-left: 5px; font-size: 0.9em; }
        .btn-filtro { 
            background: #eee; border: 1px solid #ccc; padding: 6px 12px; 
            cursor: pointer; border-radius: 20px; font-size: 12px; transition: 0.3s;
        }
        .btn-filtro.ativo { background: #D4AF37; color: white; border-color: #B8952E; }
        .btn-add { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .status-select { padding: 5px; border-radius: 5px; cursor: pointer; border: 1px solid #ddd; }
        
        @media (max-width: 768px) {
            .dashboard-container { grid-template-columns: 1fr !important; }
        }
    </style>
</head>
<body style="background: #f8f9fa; padding: 20px; font-family: 'Segoe UI', sans-serif;">

    <script>
        // [STI] Autentica√ß√£o de Seguran√ßa
        const senhaDefinida = "1234";
        const entrada = prompt("√Årea Restrita [STI]. Senha de acesso:");
        if (entrada !== senhaDefinida) {
            alert("Acesso negado!");
            window.location.replace("index.html");
        }
    </script>

    <div style="max-width: 1300px; margin: 0 auto;">
        
        <header class="card-gestao" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            <div>
                <h2 style="color: #D4AF37; margin: 0;">Gest√£o Elizabeth Cruz</h2>
                <p style="color: #666; font-size: 14px; margin: 5px 0 0 0;">Controle avan√ßado de pacientes [STI]</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="carregarDados()" style="background: #4285F4; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">üîÑ Atualizar</button>
                <button onclick="exportarParaPDF()" style="background: #2E7D32; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">üìÑ PDF Seguro</button>
            </div>
        </header>

        <section class="card-gestao">
            <h3 style="color: #D4AF37; margin-top: 0;">üë• Gest√£o de Funcion√°rios</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <input type="text" id="func-nome" placeholder="Nome do Funcion√°rio" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; flex: 2; min-width: 200px;">
                <input type="text" id="func-cargo" placeholder="Cargo/Fun√ß√£o" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; flex: 1; min-width: 150px;">
                <button class="btn-add" onclick="adicionarFuncionario()">‚ûï Adicionar √† Equipe</button>
            </div>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid #D4AF37; text-align: left;">
                        <th style="padding: 10px;">Nome</th>
                        <th style="padding: 10px;">Cargo</th>
                        <th style="padding: 10px; text-align: center;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="tabela-funcionarios"></tbody>
            </table>
        </section>

        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 25px;" class="dashboard-container">
            <div class="card-gestao">
                <h3 style="color: #D4AF37; margin-top: 0; text-align: center;">Resumo de Status</h3>
                <canvas id="chartStatus"></canvas>
            </div>
            <div class="card-gestao" style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
                <h1 id="totalAgendamentos" style="font-size: 48px; color: #333; margin: 0;">0</h1>
                <p style="color: #666;">Total de Pacientes Cadastrados</p>
                <div style="margin-top: 20px; display: flex; gap: 5px; flex-wrap: wrap; justify-content: center;">
                    <button class="btn-filtro ativo" onclick="toggleColuna(0, this)">Data</button>
                    <button class="btn-filtro ativo" onclick="toggleColuna(1, this)">CPF</button>
                    <button class="btn-filtro ativo" onclick="toggleColuna(3, this)">Respons√°vel</button>
                    <button class="btn-filtro ativo" onclick="toggleColuna(4, this)">Mensagem</button>
                </div>
            </div>
        </div>

        <div class="card-gestao" style="overflow-x: auto;">
            <table id="tabela-admin" style="width: 100%; border-collapse: collapse; min-width: 900px;">
                <thead>
                    <tr style="background: #D4AF37; color: white;">
                        <th style="padding: 15px; text-align: left;">Data</th>
                        <th style="padding: 15px; text-align: left;">CPF</th>
                        <th style="padding: 15px; text-align: left;">Paciente</th>
                        <th style="padding: 15px; text-align: left;">Respons√°vel</th> 
                        <th style="padding: 15px; text-align: left;">Mensagem</th>
                        <th style="padding: 15px; text-align: center;">Status</th>
                        <th style="padding: 15px; text-align: center;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="corpo-tabela">
                    <tr><td colspan="7" style="text-align:center; padding: 30px;">Iniciando sistema STI...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // [STI] Configura√ß√£o de Rede
        const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:3000' : 'https://clinica-elizabeth19-01-2026.onrender.com';
        let meuGrafico = null;
        let listaFuncionariosGlobal = [];

        // --- PRIVACIDADE ---
        function aplicarMascaraPrivacidade(texto, tipo) {
            if (!texto || texto === '---' || texto === 'null') return '---';
            if (tipo === 'cpf') return texto.replace(/(\d{3})\.(\d{3})\.(\d{3})-(\d{2})/, '***.$2.$3-**');
            if (tipo === 'tel') return texto.replace(/(\d{2})(\d{5})(\d{4})/, '($1) *****-$3');
            return texto;
        }

        function toggleDado(btn, valorReal, tipo) {
            const span = btn.previousElementSibling;
            if (span.getAttribute('data-visivel') === 'false') {
                span.innerText = valorReal;
                span.setAttribute('data-visivel', 'true');
                btn.innerText = 'üëÅÔ∏è‚Äçüó®Ô∏è';
            } else {
                span.innerText = aplicarMascaraPrivacidade(valorReal, tipo);
                span.setAttribute('data-visivel', 'false');
                btn.innerText = 'üëÅÔ∏è';
            }
        }

        // --- CARREGAMENTO DE DADOS ---
        async function carregarDados() {
            try {
                console.log(">>> [STI] Sincronizando dados com o servidor...");
                
                // 1. Carregar Funcion√°rios
                const resFunc = await fetch(`${API_BASE_URL}/api/funcionarios`);
                listaFuncionariosGlobal = await resFunc.json();
                renderizarTabelaFuncionarios();

                // 2. Carregar Contatos
                const resCont = await fetch(`${API_BASE_URL}/api/listar-contatos`);
                const agendamentos = await resCont.json();
                
                const corpo = document.getElementById("corpo-tabela");
                corpo.innerHTML = "";
                document.getElementById('totalAgendamentos').innerText = agendamentos.length;
                let statusCount = { 'Pendente': 0, 'Atendido': 0, 'Cancelado': 0 };

                agendamentos.forEach(cli => {
                    const statusAtual = cli.status || 'Pendente';
                    statusCount[statusAtual]++;

                    const linkZap = `https://api.whatsapp.com/send?phone=55${(cli.telefone || '').replace(/\D/g,'')}`;

                    // Select Respons√°vel
                    let selectFunc = `<select onchange="vincularFuncionario(${cli.id}, this.value)" class="status-select">
                        <option value="N√£o Atribu√≠do">-- Vincular --</option>`;
                    listaFuncionariosGlobal.forEach(f => {
                        selectFunc += `<option value="${f.nome}" ${cli.funcionario_resp === f.nome ? 'selected' : ''}>${f.nome}</option>`;
                    });
                    selectFunc += `</select>`;

                    corpo.innerHTML += `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 15px; font-size: 0.85em;">${new Date(cli.data_cadastro).toLocaleDateString('pt-BR')}</td>
                            <td style="padding: 15px; font-family: monospace;">
                                <span data-visivel="false">${aplicarMascaraPrivacidade(cli.cpf, 'cpf')}</span>
                                <span class="privacidade-toggle" onclick="toggleDado(this, '${cli.cpf}', 'cpf')">üëÅÔ∏è</span>
                            </td>
                            <td style="padding: 15px; font-weight: bold;">${cli.nome_completo}</td>
                            <td style="padding: 15px;">${selectFunc}</td> 
                            <td style="padding: 15px; color: #666; font-size: 0.85em;">${cli.mensagem || '-'}</td>
                            <td style="padding: 15px; text-align: center;">
                                <select onchange="atualizarStatus(${cli.id}, this.value)" class="status-select" 
                                        style="background: ${statusAtual === 'Atendido' ? '#d4edda' : (statusAtual === 'Cancelado' ? '#f8d7da' : '#fff3cd')};">
                                    <option value="Pendente" ${statusAtual === 'Pendente' ? 'selected' : ''}>Pendente</option>
                                    <option value="Atendido" ${statusAtual === 'Atendido' ? 'selected' : ''}>Atendido</option>
                                    <option value="Cancelado" ${statusAtual === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
                                </select>
                            </td>
                            <td style="padding: 15px; text-align: center;">
                                <a href="${linkZap}" target="_blank" style="text-decoration:none; margin-right: 12px;" title="WhatsApp">üí¨</a>
                                <span onclick="confirmarExclusao(${cli.id})" style="cursor:pointer; color: red; font-size: 1.1em;" title="Excluir">üóëÔ∏è</span>
                            </td>
                        </tr>`;
                });
                renderizarGrafico(statusCount);
                console.log(">>> [STI] Dados carregados com sucesso.");
            } catch (err) { 
                console.error("X [STI] Erro cr√≠tico na sincroniza√ß√£o:", err); 
                document.getElementById("corpo-tabela").innerHTML = `<tr><td colspan="7" style="text-align:center; color:red; padding:20px;">Erro de conex√£o com o servidor STI.</td></tr>`;
            }
        }

        // --- GEST√ÉO DE EQUIPE ---
        function renderizarTabelaFuncionarios() {
            const corpo = document.getElementById("tabela-funcionarios");
            corpo.innerHTML = "";
            listaFuncionariosGlobal.forEach(f => {
                corpo.innerHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px;">${f.nome}</td>
                        <td style="padding: 10px;">${f.cargo}</td>
                        <td style="padding: 10px; text-align: center;">
                            <button onclick="excluirFuncionario(${f.id})" style="border:none; background:none; color:red; cursor:pointer; font-size: 1.1em;">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });
        }

        async function adicionarFuncionario() {
            const nome = document.getElementById("func-nome").value;
            const cargo = document.getElementById("func-cargo").value;
            if(!nome || !cargo) return alert("STI: Preencha Nome e Cargo!");
            
            try {
                await fetch(`${API_BASE_URL}/api/funcionarios`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ nome, cargo }) 
                });
                document.getElementById("func-nome").value = ""; 
                document.getElementById("func-cargo").value = "";
                carregarDados();
            } catch (e) { console.error("X [STI] Erro ao adicionar funcion√°rio."); }
        }

        async function excluirFuncionario(id) {
            if(confirm("STI: Deseja remover este funcion√°rio da equipe?")) {
                await fetch(`${API_BASE_URL}/api/funcionarios/${id}`, { method: 'DELETE' });
                carregarDados();
            }
        }

        // --- A√á√ïES ADMIN ---
        async function atualizarStatus(id, status) {
            await fetch(`${API_BASE_URL}/api/atualizar-status/${id}`, { 
                method: 'PATCH', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ status }) 
            });
            carregarDados();
        }

        async function vincularFuncionario(id, funcionario) {
            await fetch(`${API_BASE_URL}/api/vincular-funcionario/${id}`, { 
                method: 'PATCH', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ funcionario }) 
            });
            console.log(`>>> [STI] V√≠nculo atualizado: ID ${id} -> ${funcionario}`);
        }

        async function confirmarExclusao(id) {
            if(confirm("STI: Excluir este agendamento permanentemente do banco?")) {
                await fetch(`${API_BASE_URL}/api/excluir-contato/${id}`, { method: 'DELETE' });
                carregarDados();
            }
        }

        // --- UTILIT√ÅRIOS (GR√ÅFICOS, PDF, TOGGLE) ---
        function exportarParaPDF() {
            console.log(">>> [STI] Gerando relat√≥rio PDF...");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            doc.text("Relat√≥rio Geral de Pacientes - Cl√≠nica Elizabeth Cruz", 14, 15);
            doc.autoTable({ 
                html: '#tabela-admin', 
                startY: 25, 
                theme: 'grid', 
                headStyles: { fillColor: [212, 175, 55] } 
            });
            doc.save("relatorio_clinica_STI.pdf");
        }

        function renderizarGrafico(counts) {
            const ctx = document.getElementById('chartStatus').getContext('2d');
            if (meuGrafico) meuGrafico.destroy();
            meuGrafico = new Chart(ctx, { 
                type: 'doughnut', 
                data: { 
                    labels: ['Pendente', 'Atendido', 'Cancelado'], 
                    datasets: [{ 
                        data: [counts['Pendente'], counts['Atendido'], counts['Cancelado']], 
                        backgroundColor: ['#fff3cd', '#d4edda', '#f8d7da'],
                        borderWidth: 1
                    }] 
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function toggleColuna(idx, btn) {
            const table = document.getElementById("tabela-admin");
            for (let i = 0; i < table.rows.length; i++) {
                const cell = table.rows[i].cells[idx];
                if(cell) cell.classList.toggle("col-oculta");
            }
            btn.classList.toggle("ativo");
        }

        window.onload = carregarDados;
    </script>
</body>
</html>